# るんちょま対話型学習機能 実装タスクリスト

## 概要
るんちょまが答えを間違えた際の学習フローを、現在の自由入力形式から、過去の質問を再利用する対話形式へと変更する。

---

### ステータス：進行中

### タスク一覧

- [x] **UIの変更 (`index.html`, `style.css`, `ui.js`)**
    - [x] 学習フェーズ専用のUIをデザイン・実装する。
    - [x] 現在の質問ボタン（はい/いいえ/不明）を、学習フェーズで再利用できるように調整する。
    - [x] 新しいUI要素（例：「この質問は当てはまりますか？」というメッセージ表示エリア）を追加する。

- [x] **ゲームフローの変更 (`gameCore.js`)**
    - [x] `promptForAnswer`関数を修正し、新しい学習フローを開始するように変更する。
    - [x] `handleSubmitAnswer`関数を、新しい対話形式のロジックに合わせて全面的に書き直す。
    - [x] 学習フェーズ中に、過去の質問を一つずつユーザーに問いかける処理を実装する。
    - [x] ユーザーの回答（はい/いいえ/不明）に応じて、新しいアイテムの特性情報を一時的に構築する処理を実装する。
    - [x] 全ての質問が終わった後、完成した新しいアイテムデータを`dataManager.js`に渡す処理を実装する。
    - [x] どの質問をユーザーにしたかを、ゲームセッションを通じて正確に追跡・管理する仕組みを強化する。

- [x] **データ管理の確認 (`dataManager.js`)**
    - [x] `addNewItem`関数が、新しく構築されたアイテムデータを正しく受け取り、既存のデータとマージして保存できることを確認する。

- [x] **総合テスト・自動化**
    - [x] 新しい対話型学習フローが、意図通りに動作することを全体を通してテストする。
    - [x] 学習させた新しいアイテムが、次回のプレイ時に正しく特定されることを確認する。
    - [x] テストの自動化（ユニットテスト・E2Eテスト等）の導入・整備。
    - [memo] DB連携前に、既存の学習フローやデータ管理のテスト・自動化を優先すること。これにより、DB連携時の不具合切り分けや回帰テストが容易になる。
    - [memo] テスト自動化が整っていれば、DB連携後も安心して機能追加・修正ができる。

---
### タスク: 運用形態切り替え機能の実装

*   **目的:** ローカル/スタンドアロン環境と、GCP/スプレッドシート環境を柔軟に切り替えられるようにし、開発効率と将来の運用コスト管理を両立させる。
*   **ステータス:** **進行中**

*   **タスクリスト:**
    *   **[x] 設計:**
        *   [x] 現状のコードベースと要件のヒアリング (完了)
        *   [x] フロントエンド(静的)とバックエンド(動的)の分離構成を定義 (完了)
        *   [x] データソース（ローカル vs スプレッドシート）の抽象化レイヤーを定義 (完了)
        *   [x] 実行環境（スタンドアロン vs GCP）のアダプターパターンを定義 (完了)
        *   [x] 管理者用ページによる設定切り替えの仕様を定義 (完了)
        *   [x] 上記内容を中間報告書（Markdown）としてまとめる (完了)
    *   **[x] 実装: バックエンド**
        *   [x] `package.json`に`express`を追加する。
        *   [x] `server.js`（スタンドアロン用サーバー）の雛形を作成する。
        *   [x] `src/data/spreadsheetClient.js`を作成し、スプレッドシートに接続する基本機能（読み込み）を実装する。
        *   [x] `src/data/dataManager.js`を修正し、環境変数に応じて`localData`と`spreadsheetClient`を切り替えるロジックを実装する。
        *   [ ] `index.js`（GCP用エントリポイント）を作成し、`dataManager`経由でデータを取得するAPIを実装する。
    *   **[x] 実装: フロントエンド**
        *   [x] `public`ディレクトリを作成し、`index.html`や`style.css`などを移動する。
        *   [x] フロントエンドのJavaScriptを修正し、バックエンドAPI (`/api/init`など) を`fetch`で呼び出すように変更する。
        *   [x] `ui.js`と`utils.js`を`public`ディレクトリに移動する。
    *   **[x] 実装: 管理機能**
        *   [x] `admin.html`を作成し、パスワード入力と設定変更ボタンを設置する。
        *   [x] バックエンドに管理者用API (`/api/update-config`) を実装し、パスワード認証と設定保存機能を追加する。
    *   **[ ] テストとデプロイ**
        *   [ ] ローカル環境でスタンドアロンサーバーが動作することを確認する。
        *   [ ] GCP環境に変数を設定し、スプレッドシートと連携して動作することを確認する。
        *   [ ] フロントエンドをGitHub Pagesにデプロイし、GCP上のバックエンドと正常に通信できることを確認する。

## 現在の課題
- **JavaScriptモジュールの読み込み問題:**
    - `http://localhost:3000/src/utils.js` など、`src` ディレクトリ内のJavaScriptファイルが `NS_ERROR_CORRUPTED_CONTENT` および `disallowed MIME type ("text/html")` エラーで読み込まれない。
    - これは、サーバーがこれらのファイルをJavaScriptとして正しく提供できていない、あるいはファイル自体を見つけられていないため。
    - `server.js` の `app.use(express.static(__dirname));` 設定と、JavaScriptファイルのインポートパスの組み合わせに問題がある可能性が高い。
- **ゲーム画面のボタン無反応:**
    - JavaScriptモジュールの読み込み失敗が原因で、イベントリスナーが正しく設定されていない、または初期化処理が完了していないため。
- **ゲームの文章が古い:**
    - データソースの読み込みが正しく行われていないため。これもJavaScriptモジュールの読み込み問題に起因する可能性が高い。

---