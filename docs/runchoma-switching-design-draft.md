# るんちょまの『教えて下さい、お人間さん』 - 運用形態切り替え設計案

## 1. はじめに

### 1.1. 目的
本設計案は、「るんちょまの『教えて下さい、お人間さん』」アプリケーションにおいて、複数の運用形態を柔軟に切り替えるためのアーキテクチャを定義するものです。
主な目的は以下の通りです。

*   **開発効率の向上:** ネットワーク環境に依存しないスタンドアロン（ローカル）環境での迅速な開発・デバッグを可能にする。
*   **将来の拡張性確保:** GCP (Google Cloud Platform) などのクラウド/サーバレス環境へのスムーズな展開を可能にする。
*   **コスト管理の柔軟性:** サーバレス環境の運用コストが想定を上回った場合などに、スタンドアロンのサーバー運用へスムーズに移行できるよう、両方の選択肢を確保する。

### 1.2. 背景
現在、Googleスプレッドシートをデータベースとして利用し、GCP (Cloud Run) へのデプロイが進められています。この先進的な構成を活かしつつ、ローカルでの開発や、将来的なホスティング先の変更にも耐えうる、より堅牢で柔軟なシステムを目指します。

## 2. 全体アーキテクチャ

### 2.1. フロントエンドとバックエンドの完全分離
本設計の核となる考え方です。

*   **フロントエンド (静的コンテンツ):**
    *   **役割:** UIの表示、ユーザー操作の受付など、見た目に関するすべてを担当します。
    *   **構成要素:** `index.html`, `style.css`, フロントエンド用JavaScriptファイル群。
    *   **ホスティング先:** GitHub Pages, `wanderingdj.jp`, Vercel, Netlifyなど、静的ファイルを配信できる任意のサーバー。**バックエンドから完全に独立しているため、ホスティング先を自由に変更できます。**

*   **バックエンド (動的コンテンツ / APIサーバー):**
    *   **役割:** ゲームのコアロジック実行、スコア計算、データベース（Googleスプレッドシート等）との連携など、頭脳となる処理を担当します。
    *   **構成要素:** Node.jsで動作するAPIサーバー。
    *   **ホスティング先:** GCP (Cloud Functions, Cloud Run), AWS Lambda, または自己管理のVPSなど。

### 2.2. 通信フロー
1.  ユーザーはブラウザでフロントエンドのURL（例: `https://mitsuru-tagami.github.io/runchoma-oshiete/`）にアクセスします。
2.  ブラウザはHTML, CSS, JSファイルをダウンロードし、画面を表示します。
3.  ユーザーがゲームを開始・操作すると、フロントエンドのJavaScriptが、バックエンドのAPIエンドポイント（例: `https://your-gcp-api-endpoint.run.app/api/answer`）に対して`fetch`リクエストを送信します。
4.  バックエンドはリクエストを処理し、結果をJSON形式でフロントエンドに返却します。
5.  フロントエンドは受け取ったJSONを元に、画面表示を更新します。

![Architecture Diagram](https://i.imgur.com/example.png)  <!-- あとで実際の図に差し替える -->

## 3. 設計方針詳細

### 3.1. データソースの抽象化
データベースへのアクセス方法を共通化し、切り替えを容易にします。

*   **`dataManager.js`:** データソース切り替えの司令塔となります。環境変数 `DATA_SOURCE` の値に応じて、使用するデータクライアントを決定します。
*   **`localData.js`:** 従来の`data.js`の役割を引き継ぎ、ローカルのJavaScriptオブジェクトをデータソースとして扱います。
*   **`spreadsheetClient.js`:** Googleスプレッドシートにアクセスするためのロジックをこのファイルに集約します。`google-spreadsheet`ライブラリなどを利用します。

### 3.2. 実行環境アダプター
実行環境ごとの差異を吸収します。

*   **スタンドアロン用 (`server.js`):**
    *   `express`フレームワークを利用した軽量なHTTPサーバー。
    *   ローカル開発時に `node server.js` で起動します。
    *   フロントエンドからのAPIリクエストを受け付け、コアロジックを呼び出します。
*   **GCP/サーバレス用 (`index.js`):**
    *   Cloud FunctionsやCloud Runがエントリーポイントとして利用するファイル。
    *   プラットフォームから渡されるリクエストオブジェクトを処理し、コアロジックを呼び出す役割は`server.js`と同じです。

### 3.3. 設定の外部管理と切り替え
*   **`config.js` / 環境変数:** スプレッドシートIDやAPIキーなどの機密情報は、Git管理外の`config.js`や、GCPの環境変数機能で管理します。
*   **管理者ページ (`admin.html`):**
    *   パスワードで保護された管理者専用のHTMLページを用意します。
    *   このページからバックエンドの管理者用APIを呼び出すことで、**本番環境のデータソース（local vs spreadsheet）を安全に切り替えることができます。**
    *   イメージは、ルーターの設定画面に近いです。

## 4. 推奨ファイル構成案

```
runchoma-oshiete/
├── public/              # フロントエンド (静的ファイル)
│   ├── index.html
│   ├── style.css
│   └── scripts/
│       └── main.js      # フロントエンドのメインロジック
├── admin.html           # 管理者用ページ (ローカルでのみアクセス)
├── src/
│   ├── core/              # バックエンドのコアロジック
│   │   ├── gameCore.js
│   │   └── questionSelector.js
│   ├── data/              # データ関連
│   │   ├── dataManager.js   # データソース切り替えの司令塔
│   │   ├── localData.js     # ローカルデータ用クライアント
│   │   └── spreadsheetClient.js # スプレッドシート用クライアント
│   └── utils.js
├── server.js              # スタンドアロン用サーバー
├── index.js               # GCP(Cloud Functions/Run)用エントリポイント
├── config.js.example      # 設定ファイルのテンプレート
└── package.json
```

## 5. 実装タスクリスト案

この設計を実現するためのタスクリスト案です。既存の`TASK_LIST.md`へのマージを想定しています。

---
### タスク: 運用形態切り替え機能の実装

*   **目的:** ローカル/スタンドアロン環境と、GCP/スプレッドシート環境を柔軟に切り替えられるようにし、開発効率と将来の運用コスト管理を両立させる。
*   **ステータス:** **計画中**

*   **タスクリスト:**
    *   **[ ] 設計:**
        *   [x] 現状のコードベースと要件のヒアリング (完了)
        *   [x] フロントエンド(静的)とバックエンド(動的)の分離構成を定義 (完了)
        *   [x] データソース（ローカル vs スプレッドシート）の抽象化レイヤーを定義 (完了)
        *   [x] 実行環境（スタンドアロン vs GCP）のアダプターパターンを定義 (完了)
        *   [x] 管理者用ページによる設定切り替えの仕様を定義 (完了)
        *   [x] 上記内容を中間報告書（Markdown）としてまとめる (完了)
    *   **[ ] 実装: バックエンド**
        *   [ ] `package.json`に`express`を追加する。
        *   [ ] `server.js`（スタンドアロン用サーバー）の雛形を作成する。
        *   [ ] `src/data/spreadsheetClient.js`を作成し、スプレッドシートに接続する基本機能（読み込み）を実装する。
        *   [ ] `src/data/dataManager.js`を修正し、環境変数に応じて`localData`と`spreadsheetClient`を切り替えるロジックを実装する。
        *   [ ] `index.js`（GCP用エントリポイント）を作成し、`dataManager`経由でデータを取得するAPIを実装する。
    *   **[ ] 実装: フロントエンド**
        *   [ ] `public`ディレクトリを作成し、`index.html`や`style.css`などを移動する。
        *   [ ] フロントエンドのJavaScriptを修正し、バックエンドAPI (`/api/init`など) を`fetch`で呼び出すように変更する。
    *   **[ ] 実装: 管理機能**
        *   [ ] `admin.html`を作成し、パスワード入力と設定変更ボタンを設置する。
        *   [ ] バックエンドに管理者用API (`/api/update-config`) を実装し、パスワード認証と設定保存機能を追加する。
    *   **[ ] テストとデプロイ**
        *   [ ] ローカル環境でスタンドアロンサーバーが動作することを確認する。
        *   [ ] GCP環境に変数を設定し、スプレッドシートと連携して動作することを確認する。
        *   [ ] フロントエンドをGitHub Pagesにデプロイし、GCP上のバックエンドと正常に通信できることを確認する。
---
